# Prompt Manager - 数据库设计文档

## 设计理念

> "数据库设计如同建筑设计，既要满足当下需求，又要为未来留下扩展的空间"

本数据库设计遵循以下原则：
1. **高内聚，低耦合** - 每个表职责单一，表间关系清晰
2. **扩展性优先** - 预留扩展字段，支持未来功能演进
3. **性能考虑** - 合理的索引设计，查询优化
4. **数据完整性** - 约束设计保证数据质量
5. **审美原则** - 字段命名优雅，结构清晰

## 核心实体关系图

```
用户(users) 1:N 提示词(prompts)
提示词(prompts) 1:N 版本(prompt_versions)
提示词(prompts) N:M 标签(tags) -> 提示词标签关联(prompt_tags)
用户(users) N:M 提示词(prompts) -> 协作关系(prompt_collaborators)
提示词(prompts) 1:N 测试记录(test_records)
```

## 数据表设计

### 1. 用户表 (users)
```sql
CREATE TABLE users (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '用户唯一标识',
    username VARCHAR(50) NOT NULL UNIQUE COMMENT '用户名，用于登录',
    email VARCHAR(100) NOT NULL UNIQUE COMMENT '邮箱地址',
    password_hash VARCHAR(255) NOT NULL COMMENT '密码哈希值',
    display_name VARCHAR(100) NOT NULL COMMENT '显示名称',
    avatar_url VARCHAR(500) NULL COMMENT '头像URL',
    bio TEXT NULL COMMENT '个人简介',
    preferences JSON NULL COMMENT '用户偏好设置(主题、语言等)',
    status TINYINT DEFAULT 1 COMMENT '用户状态: 1-正常, 0-禁用, -1-删除',
    last_login_at TIMESTAMP NULL COMMENT '最后登录时间',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    
    INDEX idx_username (username),
    INDEX idx_email (email),
    INDEX idx_status (status),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户基础信息表';
```

### 2. 提示词表 (prompts)
```sql
CREATE TABLE prompts (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '提示词唯一标识',
    title VARCHAR(200) NOT NULL COMMENT '提示词标题',
    description TEXT NULL COMMENT '提示词描述',
    content TEXT NOT NULL COMMENT '提示词内容',
    content_hash VARCHAR(64) NOT NULL COMMENT '内容哈希值，用于版本对比',
    owner_id BIGINT NOT NULL COMMENT '创建者用户ID',
    category VARCHAR(50) NULL COMMENT '分类',
    language VARCHAR(10) DEFAULT 'zh-CN' COMMENT '语言代码',
    model_type VARCHAR(50) NULL COMMENT '适用的AI模型类型',
    visibility TINYINT DEFAULT 1 COMMENT '可见性: 1-私有, 2-协作者, 3-公开',
    status TINYINT DEFAULT 1 COMMENT '状态: 1-正常, 0-草稿, -1-删除',
    version_count INT DEFAULT 1 COMMENT '版本数量',
    test_count INT DEFAULT 0 COMMENT '测试次数',
    last_tested_at TIMESTAMP NULL COMMENT '最后测试时间',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    
    FOREIGN KEY (owner_id) REFERENCES users(id) ON DELETE CASCADE,
    INDEX idx_owner_id (owner_id),
    INDEX idx_category (category),
    INDEX idx_status (status),
    INDEX idx_visibility (visibility),
    INDEX idx_created_at (created_at),
    INDEX idx_updated_at (updated_at),
    FULLTEXT idx_content (title, description, content)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='提示词主表';
```

### 3. 提示词版本表 (prompt_versions)
```sql
CREATE TABLE prompt_versions (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '版本唯一标识',
    prompt_id BIGINT NOT NULL COMMENT '提示词ID',
    version_number INT NOT NULL COMMENT '版本号',
    title VARCHAR(200) NOT NULL COMMENT '版本标题',
    content TEXT NOT NULL COMMENT '版本内容',
    content_hash VARCHAR(64) NOT NULL COMMENT '内容哈希值',
    change_summary VARCHAR(500) NULL COMMENT '变更摘要',
    author_id BIGINT NOT NULL COMMENT '版本作者ID',
    parent_version_id BIGINT NULL COMMENT '父版本ID，用于版本树结构',
    is_current BOOLEAN DEFAULT FALSE COMMENT '是否为当前版本',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    
    FOREIGN KEY (prompt_id) REFERENCES prompts(id) ON DELETE CASCADE,
    FOREIGN KEY (author_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (parent_version_id) REFERENCES prompt_versions(id) ON DELETE SET NULL,
    UNIQUE KEY uk_prompt_version (prompt_id, version_number),
    INDEX idx_prompt_id (prompt_id),
    INDEX idx_author_id (author_id),
    INDEX idx_is_current (is_current),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='提示词版本历史表';
```

### 4. 标签表 (tags)
```sql
CREATE TABLE tags (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '标签唯一标识',
    name VARCHAR(50) NOT NULL UNIQUE COMMENT '标签名称',
    color VARCHAR(7) NULL COMMENT '标签颜色(HEX格式)',
    description VARCHAR(200) NULL COMMENT '标签描述',
    usage_count INT DEFAULT 0 COMMENT '使用次数',
    created_by BIGINT NOT NULL COMMENT '创建者ID',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    
    FOREIGN KEY (created_by) REFERENCES users(id) ON DELETE CASCADE,
    INDEX idx_name (name),
    INDEX idx_usage_count (usage_count),
    INDEX idx_created_by (created_by)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='标签表';
```

### 5. 提示词标签关联表 (prompt_tags)
```sql
CREATE TABLE prompt_tags (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '关联唯一标识',
    prompt_id BIGINT NOT NULL COMMENT '提示词ID',
    tag_id BIGINT NOT NULL COMMENT '标签ID',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    
    FOREIGN KEY (prompt_id) REFERENCES prompts(id) ON DELETE CASCADE,
    FOREIGN KEY (tag_id) REFERENCES tags(id) ON DELETE CASCADE,
    UNIQUE KEY uk_prompt_tag (prompt_id, tag_id),
    INDEX idx_prompt_id (prompt_id),
    INDEX idx_tag_id (tag_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='提示词标签关联表';
```

### 6. 协作者表 (prompt_collaborators)
```sql
CREATE TABLE prompt_collaborators (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '协作关系唯一标识',
    prompt_id BIGINT NOT NULL COMMENT '提示词ID',
    user_id BIGINT NOT NULL COMMENT '协作者用户ID',
    role TINYINT DEFAULT 2 COMMENT '角色: 1-所有者, 2-编辑者, 3-查看者',
    permissions JSON NULL COMMENT '详细权限配置',
    invited_by BIGINT NOT NULL COMMENT '邀请者ID',
    invited_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '邀请时间',
    accepted_at TIMESTAMP NULL COMMENT '接受邀请时间',
    status TINYINT DEFAULT 1 COMMENT '状态: 1-正常, 0-待接受, -1-已拒绝',
    
    FOREIGN KEY (prompt_id) REFERENCES prompts(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (invited_by) REFERENCES users(id) ON DELETE CASCADE,
    UNIQUE KEY uk_prompt_user (prompt_id, user_id),
    INDEX idx_prompt_id (prompt_id),
    INDEX idx_user_id (user_id),
    INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='提示词协作者表';
```

### 7. 测试记录表 (test_records)
```sql
CREATE TABLE test_records (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '测试记录唯一标识',
    prompt_id BIGINT NOT NULL COMMENT '提示词ID',
    prompt_version_id BIGINT NULL COMMENT '测试的版本ID',
    user_id BIGINT NOT NULL COMMENT '测试用户ID',
    model_name VARCHAR(50) NOT NULL COMMENT 'AI模型名称',
    input_content TEXT NULL COMMENT '输入内容',
    output_content TEXT NULL COMMENT '输出内容',
    response_time INT NULL COMMENT '响应时间(毫秒)',
    token_usage JSON NULL COMMENT 'Token使用情况',
    rating TINYINT NULL COMMENT '评分(1-5)',
    notes TEXT NULL COMMENT '测试备注',
    status TINYINT DEFAULT 1 COMMENT '状态: 1-成功, 0-失败, 2-超时',
    error_message TEXT NULL COMMENT '错误信息',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    
    FOREIGN KEY (prompt_id) REFERENCES prompts(id) ON DELETE CASCADE,
    FOREIGN KEY (prompt_version_id) REFERENCES prompt_versions(id) ON DELETE SET NULL,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    INDEX idx_prompt_id (prompt_id),
    INDEX idx_user_id (user_id),
    INDEX idx_model_name (model_name),
    INDEX idx_status (status),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='AI测试记录表';
```

### 8. 系统配置表 (system_configs)
```sql
CREATE TABLE system_configs (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '配置唯一标识',
    config_key VARCHAR(100) NOT NULL UNIQUE COMMENT '配置键',
    config_value TEXT NOT NULL COMMENT '配置值',
    config_type VARCHAR(20) DEFAULT 'string' COMMENT '配置类型: string, json, number, boolean',
    description VARCHAR(500) NULL COMMENT '配置描述',
    is_public BOOLEAN DEFAULT FALSE COMMENT '是否为公开配置',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    
    INDEX idx_config_key (config_key),
    INDEX idx_is_public (is_public)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='系统配置表';
```

### 9. 操作日志表 (operation_logs)
```sql
CREATE TABLE operation_logs (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '日志唯一标识',
    user_id BIGINT NULL COMMENT '操作用户ID',
    operation_type VARCHAR(50) NOT NULL COMMENT '操作类型',
    resource_type VARCHAR(50) NOT NULL COMMENT '资源类型',
    resource_id BIGINT NULL COMMENT '资源ID',
    operation_detail JSON NULL COMMENT '操作详情',
    ip_address VARCHAR(45) NULL COMMENT 'IP地址',
    user_agent TEXT NULL COMMENT '用户代理',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE SET NULL,
    INDEX idx_user_id (user_id),
    INDEX idx_operation_type (operation_type),
    INDEX idx_resource_type (resource_type),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='操作日志表';
```

## 索引优化策略

### 主要查询场景分析
1. **用户登录**: username, email查询
2. **提示词列表**: owner_id, status, visibility查询
3. **版本历史**: prompt_id, is_current查询
4. **标签筛选**: tag_id关联查询
5. **协作查询**: user_id, prompt_id查询
6. **测试记录**: prompt_id, user_id时间范围查询

### 复合索引设计
```sql
-- 提示词查询优化
ALTER TABLE prompts ADD INDEX idx_owner_status (owner_id, status, updated_at);
ALTER TABLE prompts ADD INDEX idx_visibility_status (visibility, status, created_at);

-- 版本查询优化
ALTER TABLE prompt_versions ADD INDEX idx_prompt_current (prompt_id, is_current, version_number);

-- 协作查询优化
ALTER TABLE prompt_collaborators ADD INDEX idx_user_status (user_id, status, invited_at);

-- 测试记录查询优化
ALTER TABLE test_records ADD INDEX idx_prompt_user_time (prompt_id, user_id, created_at);
```

## 数据完整性约束

### 业务规则约束
1. **版本一致性**: 每个prompt只能有一个当前版本
2. **协作权限**: 所有者不能被删除
3. **软删除**: 重要数据使用状态标记而非物理删除
4. **审计追踪**: 关键操作记录日志

### 触发器设计
```sql
-- 版本更新触发器
DELIMITER $$
CREATE TRIGGER tr_prompt_version_update 
AFTER INSERT ON prompt_versions
FOR EACH ROW
BEGIN
    -- 更新提示词的版本计数
    UPDATE prompts 
    SET version_count = version_count + 1,
        updated_at = CURRENT_TIMESTAMP
    WHERE id = NEW.prompt_id;
    
    -- 如果是当前版本，更新提示词内容
    IF NEW.is_current THEN
        UPDATE prompts 
        SET content = NEW.content,
            content_hash = NEW.content_hash
        WHERE id = NEW.prompt_id;
        
        -- 将其他版本设为非当前
        UPDATE prompt_versions 
        SET is_current = FALSE 
        WHERE prompt_id = NEW.prompt_id AND id != NEW.id;
    END IF;
END$$
DELIMITER ;
```

## 扩展性设计

### 预留扩展字段
- **JSON字段**: 用于存储灵活的配置和元数据
- **状态字段**: 支持未来的状态扩展
- **时间字段**: 完整的审计时间记录

### 分表策略准备
- **日志表**: 按月分表，提高查询性能
- **测试记录**: 按年分表，历史数据归档

### 缓存策略预留
- **热点数据**: 用户信息、常用提示词
- **计算结果**: 统计数据、搜索结果

---

*"优雅的数据库设计如同精心编排的交响乐，每个表都有自己的节拍，却又和谐统一"*

